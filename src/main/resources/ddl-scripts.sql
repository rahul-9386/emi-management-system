-- EMI Management System - DDL Scripts
-- Execute these scripts in Oracle Database to create the required tables

-- Table 1: LMS_RECEIVABLEPAYBLE_DTL_17557
-- Stores EMI receivable details
CREATE TABLE LMS_RECEIVABLEPAYBLE_DTL_17557 (
    RECEIVABLE_ID NUMBER PRIMARY KEY,
    LOAN_ACCOUNT_NO VARCHAR2(20) NOT NULL,
    PENDING_EMI_AMOUNT NUMBER(10,2) NOT NULL,
    PENALTY_CHARGES NUMBER(10,2) NOT NULL,
    TOTAL_AMOUNT NUMBER(10,2) NOT NULL,
    CREATED_DATE DATE NOT NULL
);

-- Create sequence for RECEIVABLE_ID
CREATE SEQUENCE SEQ_RECEIVABLE_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;

-- Create trigger for auto-increment
CREATE OR REPLACE TRIGGER TRG_RECEIVABLE_ID
    BEFORE INSERT ON LMS_RECEIVABLEPAYBLE_DTL_17557
    FOR EACH ROW
BEGIN
    :NEW.RECEIVABLE_ID := SEQ_RECEIVABLE_ID.NEXTVAL;
END;
/

-- Table 2: LMS_RECEIPT_PAYMENT_DTL_17557
-- Stores user payment receipts
CREATE TABLE LMS_RECEIPT_PAYMENT_DTL_17557 (
    RECEIPT_ID NUMBER PRIMARY KEY,
    LOAN_ACCOUNT_NO VARCHAR2(20) NOT NULL,
    PAYMENT_AMOUNT NUMBER(10,2) NOT NULL,
    PAYMENT_MODE VARCHAR2(20) NOT NULL,
    PAYMENT_DATE DATE NOT NULL
);

-- Create sequence for RECEIPT_ID
CREATE SEQUENCE SEQ_RECEIPT_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;

-- Create trigger for auto-increment
CREATE OR REPLACE TRIGGER TRG_RECEIPT_ID
    BEFORE INSERT ON LMS_RECEIPT_PAYMENT_DTL_17557
    FOR EACH ROW
BEGIN
    :NEW.RECEIPT_ID := SEQ_RECEIPT_ID.NEXTVAL;
END;
/

-- Table 3: LMS_ALLOCATION_DTL_17557_
-- Stores allocation details of payments
CREATE TABLE LMS_ALLOCATION_DTL_17557_ (
    ALLOCATION_ID NUMBER PRIMARY KEY,
    LOAN_ACCOUNT_NO VARCHAR2(20) NOT NULL,
    ALLOCATED_TO VARCHAR2(20) NOT NULL CHECK (ALLOCATED_TO IN ('Penalty', 'EMI')),
    ALLOCATED_AMOUNT NUMBER(10,2) NOT NULL,
    ALLOCATION_DATE DATE NOT NULL
);

-- Create sequence for ALLOCATION_ID
CREATE SEQUENCE SEQ_ALLOCATION_ID
    START WITH 1
    INCREMENT BY 1
    NOCACHE;

-- Create trigger for auto-increment
CREATE OR REPLACE TRIGGER TRG_ALLOCATION_ID
    BEFORE INSERT ON LMS_ALLOCATION_DTL_17557_
    FOR EACH ROW
BEGIN
    :NEW.ALLOCATION_ID := SEQ_ALLOCATION_ID.NEXTVAL;
END;
/

-- Create indexes for better performance
CREATE INDEX IDX_RECEIVABLE_LOAN_ACC ON LMS_RECEIVABLEPAYBLE_DTL_17557(LOAN_ACCOUNT_NO);
CREATE INDEX IDX_RECEIPT_LOAN_ACC ON LMS_RECEIPT_PAYMENT_DTL_17557(LOAN_ACCOUNT_NO);
CREATE INDEX IDX_ALLOCATION_LOAN_ACC ON LMS_ALLOCATION_DTL_17557_(LOAN_ACCOUNT_NO);

-- Create check constraints
ALTER TABLE LMS_RECEIVABLEPAYBLE_DTL_17557
ADD CONSTRAINT CHK_PENDING_EMI_POSITIVE CHECK (PENDING_EMI_AMOUNT >= 0);

ALTER TABLE LMS_RECEIVABLEPAYBLE_DTL_17557
ADD CONSTRAINT CHK_PENALTY_POSITIVE CHECK (PENALTY_CHARGES >= 0);

ALTER TABLE LMS_RECEIPT_PAYMENT_DTL_17557
ADD CONSTRAINT CHK_PAYMENT_POSITIVE CHECK (PAYMENT_AMOUNT > 0);

ALTER TABLE LMS_ALLOCATION_DTL_17557_
ADD CONSTRAINT CHK_ALLOCATED_POSITIVE CHECK (ALLOCATED_AMOUNT > 0);

-- Comments for documentation
COMMENT ON TABLE LMS_RECEIVABLEPAYBLE_DTL_17557 IS 'Stores EMI receivable details';
COMMENT ON COLUMN LMS_RECEIVABLEPAYBLE_DTL_17557.RECEIVABLE_ID IS 'Primary Key - Auto generated';
COMMENT ON COLUMN LMS_RECEIVABLEPAYBLE_DTL_17557.LOAN_ACCOUNT_NO IS 'Loan account number';
COMMENT ON COLUMN LMS_RECEIVABLEPAYBLE_DTL_17557.PENDING_EMI_AMOUNT IS 'Pending EMI amount';
COMMENT ON COLUMN LMS_RECEIVABLEPAYBLE_DTL_17557.PENALTY_CHARGES IS 'Penalty charges (â‚¹10 per day if delayed)';
COMMENT ON COLUMN LMS_RECEIVABLEPAYBLE_DTL_17557.TOTAL_AMOUNT IS 'Total amount (EMI + Penalty)';
COMMENT ON COLUMN LMS_RECEIVABLEPAYBLE_DTL_17557.CREATED_DATE IS 'Record creation date';

COMMENT ON TABLE LMS_RECEIPT_PAYMENT_DTL_17557 IS 'Stores user payment receipts';
COMMENT ON COLUMN LMS_RECEIPT_PAYMENT_DTL_17557.RECEIPT_ID IS 'Primary Key - Auto generated';
COMMENT ON COLUMN LMS_RECEIPT_PAYMENT_DTL_17557.LOAN_ACCOUNT_NO IS 'Loan account number';
COMMENT ON COLUMN LMS_RECEIPT_PAYMENT_DTL_17557.PAYMENT_AMOUNT IS 'Payment amount';
COMMENT ON COLUMN LMS_RECEIPT_PAYMENT_DTL_17557.PAYMENT_MODE IS 'Payment mode (e.g., Cash, Online, etc.)';
COMMENT ON COLUMN LMS_RECEIPT_PAYMENT_DTL_17557.PAYMENT_DATE IS 'Payment date';

COMMENT ON TABLE LMS_ALLOCATION_DTL_17557_ IS 'Stores allocation details of payments';
COMMENT ON COLUMN LMS_ALLOCATION_DTL_17557_.ALLOCATION_ID IS 'Primary Key - Auto generated';
COMMENT ON COLUMN LMS_ALLOCATION_DTL_17557_.LOAN_ACCOUNT_NO IS 'Loan account number';
COMMENT ON COLUMN LMS_ALLOCATION_DTL_17557_.ALLOCATED_TO IS 'Allocation type: Penalty or EMI';
COMMENT ON COLUMN LMS_ALLOCATION_DTL_17557_.ALLOCATED_AMOUNT IS 'Allocated amount';
COMMENT ON COLUMN LMS_ALLOCATION_DTL_17557_.ALLOCATION_DATE IS 'Allocation date';
